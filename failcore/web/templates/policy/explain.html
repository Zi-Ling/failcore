{% extends "base.html" %}

{% block title %}Policy Explain - FailCore{% endblock %}

{% block content %}
<div class="overview">
    <h1>⚡ Policy Explain Tool</h1>
    
    <div style="margin-bottom: 1rem;">
        <a href="/policy" class="btn btn-sm">&larr; BACK</a>
    </div>
    
    <div class="trace-info-card">
        <p style="margin-bottom: 1rem;">Test what validators would trigger for a tool call without actually executing it.</p>
    </div>
    
    <form id="explain-form" onsubmit="explainTool(event)" style="margin-top: 2rem;">
        <div class="trace-info-card" style="margin-bottom: 1rem;">
            <div class="info-grid">
                <dt><label for="tool">TOOL NAME</label></dt>
                <dd>
                    <input type="text" id="tool" required placeholder="e.g. subprocess.run" 
                           style="width: 100%; padding: 0.5rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.875rem;">
                </dd>
                <dt><label for="params">PARAMETERS (JSON)</label></dt>
                <dd>
                    <textarea id="params" rows="8" placeholder='{"command": "ls -la"}' 
                              style="width: 100%; padding: 0.5rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.875rem; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary);">{}</textarea>
                </dd>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">EXPLAIN</button>
    </form>
    
    <div id="results" style="margin-top: 2rem;"></div>
</div>

<script>
    async function explainTool(event) {
        event.preventDefault();
        
        const tool = document.getElementById('tool').value;
        const paramsText = document.getElementById('params').value;
        
        try {
            const params = JSON.parse(paramsText);
            
            const response = await fetch('/api/policy/explain', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tool, params })
            });
            
            const data = await response.json();
            
            let html = `<h2 style="margin-bottom: 1rem;">Results for: <span class="badge">${data.tool}</span></h2>`;
            html += `<div class="trace-info-card" style="margin-bottom: 1rem;"><p style="color: var(--text-secondary); font-size: 0.875rem;">Parameters: <code>${JSON.stringify(data.params)}</code></p></div>`;
            
            if (data.decisions.length === 0) {
                html += '<div class="trace-info-card"><p style="color: var(--green-500);">✓ No validators triggered</p></div>';
            } else {
                html += '<div class="runs-list"><table class="runs-table"><thead><tr><th>STATUS</th><th>CODE</th><th>MESSAGE</th><th>VALIDATOR</th><th>ENFORCEMENT</th><th>ALLOWED</th></tr></thead><tbody>';
                
                data.decisions.forEach(d => {
                    const statusClass = d.enforcement === 'BLOCK' ? 'status-blocked' : 
                                       d.enforcement === 'WARN' ? 'status-error' : 'status-unknown';
                    const statusText = d.enforcement === 'BLOCK' ? 'BLOCKED' : 
                                      d.enforcement === 'WARN' ? 'WARN' : 'SHADOW';
                    
                    html += `<tr>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td><code class="run-id">${d.code}</code></td>
                        <td>${d.message}</td>
                        <td><span class="badge">${d.validator_id}</span></td>
                        <td>${d.enforcement}</td>
                        <td>${d.allowed ? '<span style="color: var(--green-500);">YES</span>' : '<span style="color: var(--red-500);">NO</span>'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                
                html += `<div class="trace-info-card" style="margin-top: 1rem;">
                    <div class="info-grid">
                        <dt><strong>BLOCKED</strong></dt>
                        <dd><span style="color: var(--red-500);">${data.summary.blocked}</span></dd>
                        <dt><strong>WARNINGS</strong></dt>
                        <dd><span style="color: var(--yellow-500);">${data.summary.warnings}</span></dd>
                        <dt><strong>SHADOWED</strong></dt>
                        <dd><span style="color: var(--text-muted);">${data.summary.shadowed}</span></dd>
                        <dt><strong>TOTAL</strong></dt>
                        <dd>${data.summary.total}</dd>
                    </div>
                </div>`;
            }
            
            document.getElementById('results').innerHTML = html;
        } catch (e) {
            document.getElementById('results').innerHTML = 
                `<div class="trace-info-card"><p style="color: var(--red-500);">Error: ${e.message}</p></div>`;
        }
    }
</script>
{% endblock %}
